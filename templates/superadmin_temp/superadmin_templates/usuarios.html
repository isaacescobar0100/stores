{% extends 'superadmin/base.html' %}

{% block title %}Gestión de Usuarios{% endblock %}
{% block page_title %}Gestión de Usuarios{% endblock %}
{% block page_subtitle %}Administrar usuarios de todas las tiendas{% endblock %}

{% block content %}
<!-- Toolbar -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="buscarUsuario" placeholder="Buscar usuario..." class="form-control" style="width: 250px;">
            <select id="filtroTienda" class="form-control" style="width: 180px;">
                <option value="">Todas las tiendas</option>
                {% for t in tiendas %}
                <option value="{{ t.id }}">{{ t.nombre }}</option>
                {% endfor %}
            </select>
            <select id="filtroRol" class="form-control" style="width: 150px;">
                <option value="">Todos los roles</option>
                <option value="admin">Admin</option>
                <option value="cocina">Cocina</option>
                <option value="mesero">Mesero</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="abrirModalNuevo()">
            <i class="fas fa-plus"></i> Nuevo Usuario
        </button>
    </div>
</div>

<!-- Estadísticas -->
<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-users"></i></div>
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Usuarios</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-user-shield"></i></div>
        <div class="stat-value">{{ stats.admins }}</div>
        <div class="stat-label">Administradores</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-utensils"></i></div>
        <div class="stat-value">{{ stats.cocina }}</div>
        <div class="stat-label">Cocina</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-concierge-bell"></i></div>
        <div class="stat-value">{{ stats.meseros }}</div>
        <div class="stat-label">Meseros</div>
    </div>
</div>

<!-- Tabla de Usuarios -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-users"></i> Usuarios del Sistema</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="table" id="tablaUsuarios">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Tienda</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Último Acceso</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-tienda="{{ usuario.tienda_id }}" data-rol="{{ usuario.rol }}">
                    <td>#{{ usuario.id }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: {% if usuario.rol == 'admin' %}var(--purple){% elif usuario.rol == 'cocina' %}var(--orange){% else %}var(--primary){% endif %}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                {{ usuario.nombre[0] if usuario.nombre else 'U' }}
                            </div>
                            <div>
                                <strong>{{ usuario.nombre }}</strong><br>
                                <small style="color: var(--gray);">{{ usuario.email }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                            {{ usuario.tienda_nombre }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{% if usuario.rol == 'admin' %}purple{% elif usuario.rol == 'cocina' %}warning{% else %}info{% endif %}">
                            {{ usuario.rol }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{% if usuario.activo %}success{% else %}danger{% endif %}">
                            {{ 'Activo' if usuario.activo else 'Inactivo' }}
                        </span>
                    </td>
                    <td>
                        <small>{{ usuario.ultimo_acceso or 'Nunca' }}</small>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-primary" onclick="editarUsuario({{ usuario.id }})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="resetPassword({{ usuario.id }})" title="Reset contraseña">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-sm btn-{% if usuario.activo %}danger{% else %}success{% endif %}"
                                    onclick="toggleUsuario({{ usuario.id }}, {{ 'true' if usuario.activo else 'false' }})"
                                    title="{{ 'Desactivar' if usuario.activo else 'Activar' }}">
                                <i class="fas fa-{% if usuario.activo %}ban{% else %}check{% endif %}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuevo/Editar Usuario -->
<div id="modalUsuario" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitulo">Nuevo Usuario</h3>
            <button class="modal-close" onclick="cerrarModal()">&times;</button>
        </div>
        <form id="formUsuario" onsubmit="guardarUsuario(event)">
            <input type="hidden" id="usuarioId" name="id">
            <div class="form-group">
                <label>Nombre Completo *</label>
                <input type="text" id="usuarioNombre" name="nombre" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="usuarioEmail" name="email" class="form-control" required>
            </div>
            <div class="form-group" id="passwordGroup">
                <label>Contraseña *</label>
                <input type="password" id="usuarioPassword" name="password" class="form-control">
                <small style="color: var(--gray);">Mínimo 6 caracteres</small>
            </div>
            <div class="form-group">
                <label>Tienda *</label>
                <select id="usuarioTienda" name="tienda_id" class="form-control" required>
                    {% for t in tiendas %}
                    <option value="{{ t.id }}">{{ t.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Rol *</label>
                <select id="usuarioRol" name="rol" class="form-control" required>
                    <option value="admin">Administrador</option>
                    <option value="cocina">Cocina</option>
                    <option value="mesero">Mesero</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
function abrirModalNuevo() {
    document.getElementById('modalTitulo').textContent = 'Nuevo Usuario';
    document.getElementById('formUsuario').reset();
    document.getElementById('usuarioId').value = '';
    document.getElementById('passwordGroup').style.display = 'block';
    document.getElementById('usuarioPassword').required = true;
    document.getElementById('modalUsuario').classList.add('active');
}

function cerrarModal() {
    document.getElementById('modalUsuario').classList.remove('active');
}

function editarUsuario(id) {
    fetch(`/superadmin/api/usuarios/${id}`)
        .then(r => r.json())
        .then(usuario => {
            document.getElementById('modalTitulo').textContent = 'Editar Usuario';
            document.getElementById('usuarioId').value = usuario.id;
            document.getElementById('usuarioNombre').value = usuario.nombre;
            document.getElementById('usuarioEmail').value = usuario.email;
            document.getElementById('usuarioTienda').value = usuario.tienda_id;
            document.getElementById('usuarioRol').value = usuario.rol;
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('usuarioPassword').required = false;
            document.getElementById('usuarioPassword').value = '';
            document.getElementById('modalUsuario').classList.add('active');
        });
}

function guardarUsuario(e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const id = data.get('id');
    const url = id ? `/superadmin/api/usuarios/${id}` : '/superadmin/api/usuarios';
    const method = id ? 'PUT' : 'POST';

    // Si es edición y no hay contraseña, quitarla
    if (id && !data.get('password')) {
        data.delete('password');
    }

    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(Object.fromEntries(data))
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Error al guardar');
        }
    });
}

function toggleUsuario(id, activo) {
    const accion = activo ? 'desactivar' : 'activar';
    if (confirm(`¿Seguro que desea ${accion} este usuario?`)) {
        fetch(`/superadmin/api/usuarios/${id}/toggle`, {method: 'POST'})
            .then(r => r.json())
            .then(result => {
                if (result.success) location.reload();
                else alert(result.error);
            });
    }
}

function resetPassword(id) {
    const nueva = prompt('Ingrese la nueva contraseña (mín 6 caracteres):');
    if (nueva && nueva.length >= 6) {
        fetch(`/superadmin/api/usuarios/${id}/password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: nueva})
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                alert('Contraseña actualizada correctamente');
            } else {
                alert(result.error);
            }
        });
    } else if (nueva) {
        alert('La contraseña debe tener al menos 6 caracteres');
    }
}

// Filtros
document.getElementById('buscarUsuario').addEventListener('input', filtrarTabla);
document.getElementById('filtroTienda').addEventListener('change', filtrarTabla);
document.getElementById('filtroRol').addEventListener('change', filtrarTabla);

function filtrarTabla() {
    const busqueda = document.getElementById('buscarUsuario').value.toLowerCase();
    const tienda = document.getElementById('filtroTienda').value;
    const rol = document.getElementById('filtroRol').value;
    const filas = document.querySelectorAll('#tablaUsuarios tbody tr');

    filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        const filaTienda = fila.dataset.tienda;
        const filaRol = fila.dataset.rol;

        let mostrar = texto.includes(busqueda);
        if (tienda) mostrar = mostrar && filaTienda === tienda;
        if (rol) mostrar = mostrar && filaRol === rol;

        fila.style.display = mostrar ? '' : 'none';
    });
}
</script>
{% endblock %}
