<!-- TEMPLATE VERSION: 2025-12-17-v4 - OFERTAS VARIANTES FIX -->
{% extends 'base.html' %}

{% block title %}{{ tienda.nombre }} - Tomar Pedido{% endblock %}

{% block extra_head %}
<style>
:root {
    --primary: {{ tienda.color_primario or '#ff441f' }};
    --secondary: {{ tienda.color_secundario or '#00b14f' }};
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: #f5f5f5;
    min-height: 100vh;
}

/* Ocultar footer en interfaz de mesero */
footer, .footer { display: none !important; }

.mesero-container {
    display: flex;
    height: 100vh;
}

.menu-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    overflow: hidden;
}

.menu-header {
    padding: 15px 20px;
    background: var(--primary);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.menu-header h1 {
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.menu-header .logo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
}

.user-info {
    font-size: 14px;
    opacity: 0.9;
}

.categories-bar {
    display: flex;
    gap: 10px;
    padding: 15px 20px;
    background: #fafafa;
    border-bottom: 1px solid #eee;
    overflow-x: auto;
    flex-shrink: 0;
}

.category-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 25px;
    background: white;
    color: #666;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    border: 2px solid #eee;
}

.category-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.category-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.products-grid {
    flex: 1;
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    overflow-y: auto;
    align-content: start;
}

.product-card {
    background: white;
    border-radius: 12px;
    overflow: visible;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    display: flex;
    flex-direction: column;
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
    border-color: var(--primary);
}

.product-card img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.product-card .placeholder {
    width: 100%;
    height: 120px;
    background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bbb;
    font-size: 40px;
    flex-shrink: 0;
}

.product-card img {
    flex-shrink: 0;
}

.product-info {
    padding: 12px;
}

.product-name {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.product-price {
    font-weight: 700;
    color: var(--primary);
    font-size: 16px;
}

.oferta-card {
    position: relative;
}

.oferta-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ef4444;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    z-index: 1;
}

.ofertas-btn {
    background: #fef2f2 !important;
    border-color: #ef4444 !important;
    color: #ef4444 !important;
}

.ofertas-btn.active {
    background: #ef4444 !important;
    color: white !important;
}

.cart-panel {
    width: 380px;
    background: white;
    border-left: 1px solid #eee;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    position: relative;
    transition: transform 0.3s ease, width 0.3s ease;
}

.cart-panel.collapsed {
    width: 0;
    min-width: 0;
}

.cart-panel.collapsed .cart-header,
.cart-panel.collapsed .cart-items,
.cart-panel.collapsed .cart-footer {
    display: none;
}

.cart-toggle {
    position: absolute;
    left: -45px;
    top: 50%;
    transform: translateY(-50%);
    width: 45px;
    height: 80px;
    background: var(--primary);
    border: none;
    border-radius: 10px 0 0 10px;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    box-shadow: -3px 0 10px rgba(0,0,0,0.1);
    z-index: 10;
}

.cart-toggle i {
    font-size: 18px;
}

.cart-toggle .badge {
    background: white;
    color: var(--primary);
    font-size: 11px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 20px;
}

.btn-logout {
    padding: 8px 15px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    color: white;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-logout:hover {
    background: rgba(255,255,255,0.25);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.cart-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.cart-header h2 {
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.cart-header h2 i {
    color: var(--primary);
}

.mesa-input {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.mesa-input label {
    font-weight: 500;
    color: #666;
}

.mesa-input input, .mesa-input select {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #eee;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
}

.mesa-input input:focus, .mesa-input select:focus {
    outline: none;
    border-color: var(--primary);
}

.cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
}

.cart-empty {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.cart-empty i {
    font-size: 50px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.cart-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.cart-item-img {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    background: #f5f5f5;
}

.cart-item-info {
    flex: 1;
}

.cart-item-name {
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 3px;
}

.cart-item-price {
    color: #666;
    font-size: 13px;
}

.cart-item-qty {
    display: flex;
    align-items: center;
    gap: 8px;
}

.qty-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 50%;
    background: #f0f0f0;
    color: #666;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.qty-btn:hover {
    background: var(--primary);
    color: white;
}

.qty-btn.minus:hover {
    background: #ef4444;
}

.qty-value {
    font-weight: 600;
    min-width: 25px;
    text-align: center;
}

.cart-footer {
    padding: 20px;
    border-top: 1px solid #eee;
    background: #fafafa;
}

.cart-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 18px;
}

.cart-total-label {
    font-weight: 500;
    color: #666;
}

.cart-total-value {
    font-weight: 700;
    font-size: 24px;
    color: var(--primary);
}

.btn-enviar {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 10px;
    background: var(--secondary);
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
}

.btn-enviar:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,177,79,0.3);
}

.btn-enviar:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #333;
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: 500;
    opacity: 0;
    transition: all 0.3s;
    z-index: 1000;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.toast.success { background: var(--secondary); }
.toast.error { background: #ef4444; }

.notas-input {
    margin-top: 10px;
}

.notas-input textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #eee;
    border-radius: 8px;
    resize: none;
    font-family: inherit;
}

.notas-input textarea:focus {
    outline: none;
    border-color: var(--primary);
}

@media (max-width: 900px) {
    .mesero-container {
        flex-direction: column;
    }
    .cart-panel {
        width: 100%;
        max-height: 50vh;
    }
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }
}

/* Subcategorias tabs mesero */
.subcategory-tabs-mesero {
    display: none;
    gap: 8px;
    padding: 10px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
}

.subcategory-btn {
    padding: 8px 16px;
    border: 2px solid var(--primary);
    background: transparent;
    color: var(--primary);
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
}

.subcategory-btn.active {
    background: var(--primary);
    color: white;
}

.subcategory-btn:hover {
    background: var(--primary);
    color: white;
    opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="mesero-container">
    <div class="menu-panel">
        <div class="menu-header">
            <h1>
                {% if tienda.logo %}
                <img src="{{ tienda.logo }}" alt="" class="logo">
                {% endif %}
                {{ tienda.nombre }}
            </h1>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-tie"></i> {{ user.nombre }}
                </div>
                <button class="btn-logout" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <div class="categories-bar">
            <button class="category-btn active" onclick="filterCategory('all', this)">
                <i class="fas fa-utensils"></i> Todos
            </button>
            {% if ofertas %}
            <button class="category-btn ofertas-btn" onclick="filterCategory('ofertas', this)">
                <i class="fas fa-fire"></i> Ofertas
            </button>
            {% endif %}
            {% for categoria in categorias %}
            {% if categoria.padre_id is none %}
            <button class="category-btn" onclick="filterCategory('{{ categoria.nombre }}', this)" data-catid="{{ categoria.id }}">
                {{ categoria.nombre }}
            </button>
            {% endif %}
            {% endfor %}
        </div>

        <div class="products-grid" id="productsGrid">
            <!-- Ofertas -->
            {% for oferta in ofertas %}
            {% if oferta.tipo == 'descuento' and oferta.productos_ids %}
            <div class="product-card oferta-card" data-category="ofertas" onclick="showOfertaDescuentoMesero({{ oferta.id }}, '{{ oferta.titulo|replace("'", "") }}', {{ oferta.valor_descuento or 0 }})">
                <div class="oferta-badge" style="background:#10b981;">-{{ (oferta.valor_descuento or 0)|int }}%</div>
                {% if oferta.imagen %}
                <img src="{{ oferta.imagen }}" alt="{{ oferta.titulo }}">
                {% else %}
                <div class="placeholder"><i class="fas fa-tags"></i></div>
                {% endif %}
                <div class="product-info">
                    <div class="product-name">{{ oferta.titulo }}</div>
                    <div class="product-price" style="color:#10b981;font-size:12px;">Ver productos</div>
                </div>
            </div>
            {% else %}
            <div class="product-card oferta-card" data-category="ofertas" onclick="addOfertaToCart({{ oferta.id }}, '{{ oferta.titulo|replace("'", "") }}', {{ oferta.precio_oferta or 0 }}, '{{ oferta.imagen or '' }}')">
                <div class="oferta-badge">OFERTA</div>
                {% if oferta.imagen %}
                <img src="{{ oferta.imagen }}" alt="{{ oferta.titulo }}">
                {% else %}
                <div class="placeholder"><i class="fas fa-fire"></i></div>
                {% endif %}
                <div class="product-info">
                    <div class="product-name">{{ oferta.titulo }}</div>
                    <div class="product-price">${{ "{:,.0f}".format(oferta.precio_oferta or 0)|replace(",", ".") }}</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            <!-- Productos -->
            {% for categoria, data in menu.items() %}
                {% if data.tipo == 'con_subcategorias' %}
                    <!-- Subcategorias tabs -->
                    <div class="subcategory-tabs-mesero" data-category="{{ categoria }}" style="display:none;">
                        {% for subcat, productos in data.subcategorias.items() %}
                        <button class="subcategory-btn{% if loop.first %} active{% endif %}"
                                onclick="filterSubcategory('{{ categoria }}', '{{ subcat }}', this)">
                            {{ subcat }}
                        </button>
                        {% endfor %}
                    </div>
                    {% for subcat, productos in data.subcategorias.items() %}
                        {% for producto in productos %}
                        {% if producto.variantes and producto.variantes|length > 0 %}
                        <div class="product-card" data-category="{{ categoria }}" data-subcategory="{{ subcat }}" onclick="abrirVariantes({{ producto.id }})">
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}">
                            {% else %}
                            <div class="placeholder"><i class="fas fa-hamburger"></i></div>
                            {% endif %}
                            <div class="product-info">
                                <div class="product-name">{{ producto.nombre }}</div>
                                <div class="product-price" style="font-size:12px;color:#64748b;">Desde ${{ "{:,.0f}".format(producto.variantes[0]['precio']|float)|replace(",", ".") }}</div>
                            </div>
                        </div>
                        {% else %}
                        <div class="product-card" data-category="{{ categoria }}" data-subcategory="{{ subcat }}" onclick="addToCart({{ producto.id }}, '{{ producto.nombre|replace("'", "\\'") }}', {{ producto.precio }}, '{{ producto.imagen or '' }}')">
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}">
                            {% else %}
                            <div class="placeholder"><i class="fas fa-hamburger"></i></div>
                            {% endif %}
                            <div class="product-info">
                                <div class="product-name">{{ producto.nombre }}</div>
                                <div class="product-price">${{ "{:,.0f}".format(producto.precio)|replace(",", ".") }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    {% for producto in data.productos %}
                    {% if producto.variantes and producto.variantes|length > 0 %}
                    <div class="product-card" data-category="{{ categoria }}" onclick="abrirVariantes({{ producto.id }})">
                        {% if producto.imagen %}
                        <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}">
                        {% else %}
                        <div class="placeholder"><i class="fas fa-hamburger"></i></div>
                        {% endif %}
                        <div class="product-info">
                            <div class="product-name">{{ producto.nombre }}</div>
                            <div class="product-price" style="font-size:12px;color:#64748b;">Desde ${{ "{:,.0f}".format(producto.variantes[0]['precio']|float)|replace(",", ".") }}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="product-card" data-category="{{ categoria }}" onclick="addToCart({{ producto.id }}, '{{ producto.nombre|replace("'", "\\'") }}', {{ producto.precio }}, '{{ producto.imagen or '' }}')">
                        {% if producto.imagen %}
                        <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}">
                        {% else %}
                        <div class="placeholder"><i class="fas fa-hamburger"></i></div>
                        {% endif %}
                        <div class="product-info">
                            <div class="product-name">{{ producto.nombre }}</div>
                            <div class="product-price">${{ "{:,.0f}".format(producto.precio)|replace(",", ".") }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="cart-panel" id="cartPanel">
        <button class="cart-toggle" onclick="toggleCart()" title="Mostrar/Ocultar pedido">
            <i class="fas fa-shopping-cart"></i>
            <span class="badge" id="cartBadge">0</span>
        </button>
        <div class="cart-header">
            <h2><i class="fas fa-receipt"></i> Pedido Actual</h2>
            <div class="mesa-input">
                <label>Mesa #</label>
                <input type="text" id="mesaNumero" placeholder="Ej: 5" maxlength="10">
            </div>
            <div class="notas-input">
                <textarea id="notasPedido" rows="2" placeholder="Notas del pedido (opcional)..."></textarea>
            </div>
        </div>

        <div class="cart-items" id="cartItems">
            <div class="cart-empty">
                <i class="fas fa-shopping-basket"></i>
                <p>Selecciona productos del menu</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="cart-total">
                <span class="cart-total-label">Total:</span>
                <span class="cart-total-value" id="cartTotal">$0</span>
            </div>
            <button class="btn-enviar" id="btnEnviar" onclick="enviarPedido()" disabled>
                <i class="fas fa-paper-plane"></i>
                Enviar a Cocina
            </button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
let cart = [];

function cerrarSesion() {
    if (cart.length > 0) {
        if (!confirm('Tienes productos en el pedido. ¿Seguro que deseas salir?')) {
            return;
        }
    }
    window.location.href = '/logout';
}

function toggleCart() {
    const panel = document.getElementById('cartPanel');
    panel.classList.toggle('collapsed');
}

function updateCartBadge() {
    const badge = document.getElementById('cartBadge');
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    badge.textContent = totalItems;
}

// Datos de productos con variantes (generados por el servidor)
var productosConVariantes = {
{% for categoria, data in menu.items() %}
{% if data.tipo == 'con_subcategorias' %}
{% for subcat, productos in data.subcategorias.items() %}
{% for producto in productos %}
{% if producto.variantes and producto.variantes|length > 0 %}
{{ producto.id }}: { nombre: "{{ producto.nombre|replace('"', '\\"') }}", imagen: "{{ producto.imagen or '' }}", variantes: {{ producto.variantes|tojson }} },
{% endif %}
{% endfor %}
{% endfor %}
{% else %}
{% for producto in data.productos %}
{% if producto.variantes and producto.variantes|length > 0 %}
{{ producto.id }}: { nombre: "{{ producto.nombre|replace('"', '\\"') }}", imagen: "{{ producto.imagen or '' }}", variantes: {{ producto.variantes|tojson }} },
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
};

function abrirVariantes(productoId) {
    var prod = productosConVariantes[productoId];
    if (prod) {
        showVariantesModal(productoId, prod.nombre, prod.imagen, prod.variantes);
    }
}

function formatPrice(price) {
    return '$' + price.toLocaleString('es-CO');
}

function addToCart(id, nombre, precio, imagen, variante) {
    const existing = cart.find(item => item.id === id && !item.isOferta && item.nombre === nombre);
    if (existing) {
        existing.qty++;
    } else {
        cart.push({ id, nombre, precio, imagen, qty: 1, isOferta: false, variante: variante || '' });
    }
    renderCart();
    showToast('Agregado: ' + nombre, 'success');
}

function showVariantesModal(productoId, nombre, imagen, variantes) {
    // Crear modal de selección de variantes
    const modal = document.createElement('div');
    modal.id = 'variantesModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

    // Escapar caracteres especiales
    const nombreSafe = (nombre || '').replace(/'/g, "\\'").replace(/`/g, "\\`");
    const imagenSafe = (imagen || '').replace(/'/g, "\\'").replace(/`/g, "\\`");

    let variantesHTML = '';
    variantes.forEach(function(v) {
        const precio = parseFloat(v.precio) || 0;
        const vNombreSafe = (v.nombre || '').replace(/'/g, "\\'").replace(/`/g, "\\`");
        const nombreCompleto = nombreSafe + ' ' + vNombreSafe;
        variantesHTML += '<button type="button" class="variante-btn" onclick="agregarConVariante(' + productoId + ', \'' + nombreCompleto + '\', ' + precio + ', \'' + imagenSafe + '\', \'' + vNombreSafe + '\')" style="display:flex;justify-content:space-between;align-items:center;width:100%;padding:15px;margin-bottom:8px;border:2px solid #e2e8f0;background:white;border-radius:10px;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.borderColor=\'var(--primary)\';this.style.background=\'#fef2f2\'" onmouseout="this.style.borderColor=\'#e2e8f0\';this.style.background=\'white\'"><span style="font-weight:600;">' + v.nombre + '</span><span style="color:var(--primary);font-weight:700;">$' + precio.toLocaleString('es-CO') + '</span></button>';
    });

    modal.innerHTML = `
        <div style="background:white;border-radius:16px;max-width:350px;width:90%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding:20px;background:var(--primary);color:white;">
                <div style="display:flex;align-items:center;gap:12px;">
                    ${imagen ? '<img src="' + imagen + '" style="width:50px;height:50px;border-radius:8px;object-fit:cover;">' : '<div style="width:50px;height:50px;border-radius:8px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;"><i class="fas fa-utensils"></i></div>'}
                    <div>
                        <h3 style="margin:0;font-size:16px;">${nombre}</h3>
                        <div style="font-size:12px;opacity:0.9;">Selecciona una opción</div>
                    </div>
                </div>
            </div>
            <div style="padding:15px;">
                ${variantesHTML}
            </div>
            <div style="padding:0 15px 15px;">
                <button onclick="document.getElementById('variantesModal').remove()" style="width:100%;padding:12px;border:2px solid #e2e8f0;background:white;border-radius:8px;font-weight:600;cursor:pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    `;

    modal.onclick = function(e) {
        if (e.target === modal) modal.remove();
    };

    document.body.appendChild(modal);
}

function agregarConVariante(id, nombreConVariante, precio, imagen, variante) {
    document.getElementById('variantesModal').remove();
    addToCart(id, nombreConVariante, precio, imagen, variante);
}

function addOfertaToCart(id, nombre, precio, imagen) {
    const existing = cart.find(item => item.id === id && item.isOferta);
    if (existing) {
        existing.qty++;
    } else {
        cart.push({ id, nombre, precio, imagen, qty: 1, isOferta: true });
    }
    renderCart();
    showToast('Oferta agregada: ' + nombre, 'success');
}

function updateQty(id, delta) {
    const item = cart.find(i => i.id === id);
    if (item) {
        item.qty += delta;
        if (item.qty <= 0) {
            cart = cart.filter(i => i.id !== id);
        }
    }
    renderCart();
}

function renderCart() {
    const container = document.getElementById('cartItems');
    const totalEl = document.getElementById('cartTotal');
    const btnEnviar = document.getElementById('btnEnviar');

    updateCartBadge();

    if (cart.length === 0) {
        container.innerHTML = '<div class="cart-empty"><i class="fas fa-shopping-basket"></i><p>Selecciona productos del menu</p></div>';
        totalEl.textContent = '$0';
        btnEnviar.disabled = true;
        return;
    }

    let html = '';
    let total = 0;

    cart.forEach(item => {
        const subtotal = item.precio * item.qty;
        total += subtotal;

        // Calcular precio original si tiene descuento
        let precioHTML = formatPrice(item.precio);
        if (item.esDescuento && item.precioOriginal) {
            precioHTML = `<span style="text-decoration:line-through;color:#94a3b8;font-size:11px;margin-right:4px;">${formatPrice(item.precioOriginal)}</span><span style="color:#10b981;">${formatPrice(item.precio)}</span>`;
        }

        html += `
            <div class="cart-item">
                ${item.imagen ? `<img src="${item.imagen}" class="cart-item-img">` : '<div class="cart-item-img" style="display:flex;align-items:center;justify-content:center;"><i class="fas fa-utensils" style="color:#ccc;"></i></div>'}
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.nombre}</div>
                    <div class="cart-item-price">${precioHTML} x ${item.qty}</div>
                </div>
                <div class="cart-item-qty">
                    <button class="qty-btn minus" onclick="updateQty(${item.id}, -1)">-</button>
                    <span class="qty-value">${item.qty}</span>
                    <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    totalEl.textContent = formatPrice(total);
    btnEnviar.disabled = false;
}

function filterCategory(category, btn) {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Ocultar todos los tabs de subcategorias
    document.querySelectorAll('.subcategory-tabs-mesero').forEach(tabs => {
        tabs.style.display = 'none';
    });

    // Mostrar tabs de subcategorias si existen para esta categoria
    var subcatTabs = document.querySelector('.subcategory-tabs-mesero[data-category="' + category + '"]');
    if (subcatTabs) {
        subcatTabs.style.display = 'flex';
        // Activar primera subcategoria
        var firstBtn = subcatTabs.querySelector('.subcategory-btn');
        if (firstBtn) {
            var firstSubcat = firstBtn.textContent.trim();
            filterSubcategory(category, firstSubcat, firstBtn);
            return;
        }
    }

    // Sin subcategorias - filtrar normalmente
    document.querySelectorAll('.product-card').forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function filterSubcategory(category, subcategory, btn) {
    // Activar boton de subcategoria
    btn.parentElement.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Mostrar solo productos de esa subcategoria
    document.querySelectorAll('.product-card').forEach(card => {
        if (card.dataset.category === category && card.dataset.subcategory === subcategory) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function enviarPedido() {
    const mesa = document.getElementById('mesaNumero').value.trim();
    const notas = document.getElementById('notasPedido').value.trim();

    if (!mesa) {
        showToast('Ingresa el numero de mesa', 'error');
        document.getElementById('mesaNumero').focus();
        return;
    }

    if (cart.length === 0) {
        showToast('Agrega productos al pedido', 'error');
        return;
    }

    const btn = document.getElementById('btnEnviar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

    const pedido = {
        mesa: mesa,
        notas: notas,
        items: cart.map(item => {
            console.log('Item:', item.nombre, 'Variante:', item.variante);
            return {
                producto_id: item.id,
                cantidad: item.qty,
                precio_unitario: item.precio,
                notas: item.variante || ''
            };
        }),
        tipo_entrega: 'mesa',
        metodo_pago: 'efectivo'
    };
    console.log('Pedido a enviar:', JSON.stringify(pedido, null, 2));

    fetch('/api/mesero/pedido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pedido)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showToast('Pedido #' + result.pedido_id + ' enviado a cocina!', 'success');
            cart = [];
            renderCart();
            document.getElementById('mesaNumero').value = '';
            document.getElementById('notasPedido').value = '';
        } else {
            showToast(result.error || 'Error al enviar', 'error');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar a Cocina';
    })
    .catch(() => {
        showToast('Error de conexion', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar a Cocina';
    });
}

function showToast(msg, type) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast ' + (type || '') + ' show';
    setTimeout(() => toast.classList.remove('show'), 2500);
}

// Funcion para ofertas tipo descuento en mesero
async function showOfertaDescuentoMesero(ofertaId, titulo, descuento) {
    try {
        const response = await fetch('/api/oferta/' + ofertaId + '/productos');
        const data = await response.json();

        if (!data.productos || data.productos.length === 0) {
            showToast('Esta oferta no tiene productos', 'error');
            return;
        }

        // Guardar datos de productos para usar despues
        window.ofertaProductosData = data.productos;
        window.ofertaDescuento = descuento;

        // Construir HTML de productos con variantes
        let productosHTML = '';

        data.productos.forEach(function(p, idx) {
            const tieneVariantes = p.variantes && p.variantes.length > 0;
            const precioBase = parseFloat(p.precio) || 0;
            const precioBaseDesc = Math.floor(precioBase * (1 - descuento/100));
            const nombreSafe = (p.nombre || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

            productosHTML += `
                <div style="padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div style="width:50px;height:50px;border-radius:8px;background:#e2e8f0;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;">
                            ${p.imagen ? '<img src="' + p.imagen + '" style="width:100%;height:100%;object-fit:cover;">' : '<i class="fas fa-utensils" style="color:#94a3b8;"></i>'}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:#334155;">${p.nombre}</div>
                            ${tieneVariantes ? '<div style="font-size:11px;color:#64748b;">Selecciona tamaño:</div>' : ''}
                        </div>
                    </div>
                    ${tieneVariantes ? `
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
                            ${p.variantes.map(function(v) {
                                const vPrecio = parseFloat(v.precio) || 0;
                                const precioDesc = Math.floor(vPrecio * (1 - descuento/100));
                                const vNombreSafe = (v.nombre || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                return '<button type="button" class="var-btn" data-pidx="' + idx + '" data-vid="' + v.id + '" data-nombre="' + nombreSafe + ' ' + vNombreSafe + '" data-variante="' + vNombreSafe + '" data-precio="' + precioDesc + '" data-original="' + vPrecio + '" style="padding:8px 12px;border:2px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s;" onmouseover="this.style.borderColor=\'#10b981\'" onmouseout="if(!this.classList.contains(\'selected\'))this.style.borderColor=\'#e2e8f0\'" onclick="selectVariante(this)">' + v.nombre + '<br><span style="text-decoration:line-through;color:#94a3b8;font-size:10px;">$' + vPrecio.toLocaleString('es-CO') + '</span> <span style="color:#10b981;font-weight:600;">$' + precioDesc.toLocaleString('es-CO') + '</span></button>';
                            }).join('')}
                        </div>
                    ` : `
                        <div style="margin-top:8px;">
                            <span style="text-decoration:line-through;color:#94a3b8;font-size:12px;margin-right:6px;">$${precioBase.toLocaleString('es-CO')}</span>
                            <span style="color:#10b981;font-weight:600;">$${precioBaseDesc.toLocaleString('es-CO')}</span>
                            <input type="hidden" class="producto-sin-variante" data-pidx="${idx}" data-nombre="${nombreSafe}" data-precio="${precioBaseDesc}" data-original="${precioBase}">
                        </div>
                    `}
                </div>
            `;
        });

        // Crear modal
        const modal = document.createElement('div');
        modal.id = 'ofertaModalMesero';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
            <div style="background:white;border-radius:16px;max-width:450px;width:95%;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <div style="padding:20px;background:#10b981;color:white;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;font-size:18px;">${titulo}</h3>
                        <span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-weight:700;">-${descuento}%</span>
                    </div>
                </div>
                <div style="padding:15px;max-height:350px;overflow-y:auto;" id="ofertaProductosList">
                    ${productosHTML}
                </div>
                <div style="padding:15px 20px;background:#f8fafc;border-top:1px solid #e2e8f0;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                        <span style="color:#64748b;">Total seleccionado:</span>
                        <div id="ofertaTotalDisplay">
                            <span style="color:#10b981;font-weight:700;font-size:18px;">$0</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="document.getElementById('ofertaModalMesero').remove()" style="flex:1;padding:12px;border:2px solid #e2e8f0;background:white;border-radius:8px;font-weight:600;cursor:pointer;">Cancelar</button>
                        <button onclick="agregarProductosOfertaMesero()" id="btnAgregarOferta" style="flex:2;padding:12px;border:none;background:#10b981;color:white;border-radius:8px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-plus"></i> Agregar seleccionados
                        </button>
                    </div>
                </div>
            </div>
        `;

        modal.onclick = function(e) {
            if (e.target === modal) modal.remove();
        };

        document.body.appendChild(modal);

        // Calcular total inicial (productos sin variantes)
        actualizarTotalOferta();

    } catch(err) {
        console.error('Error:', err);
        showToast('Error al cargar productos', 'error');
    }
}

function selectVariante(btn) {
    // Deseleccionar otras variantes del mismo producto
    const pidx = btn.dataset.pidx;
    document.querySelectorAll('.var-btn[data-pidx="' + pidx + '"]').forEach(function(b) {
        b.classList.remove('selected');
        b.style.borderColor = '#e2e8f0';
        b.style.background = 'white';
    });

    // Seleccionar esta
    btn.classList.add('selected');
    btn.style.borderColor = '#10b981';
    btn.style.background = '#ecfdf5';

    actualizarTotalOferta();
}

function actualizarTotalOferta() {
    let total = 0;
    let totalOriginal = 0;

    // Sumar variantes seleccionadas
    document.querySelectorAll('.var-btn.selected').forEach(function(btn) {
        total += parseInt(btn.dataset.precio);
        totalOriginal += parseInt(btn.dataset.original);
    });

    // Sumar productos sin variantes
    document.querySelectorAll('.producto-sin-variante').forEach(function(inp) {
        total += parseInt(inp.dataset.precio);
        totalOriginal += parseInt(inp.dataset.original);
    });

    const display = document.getElementById('ofertaTotalDisplay');
    if (totalOriginal > 0) {
        display.innerHTML = '<span style="text-decoration:line-through;color:#94a3b8;margin-right:8px;">$' + totalOriginal.toLocaleString('es-CO') + '</span><span style="color:#10b981;font-weight:700;font-size:18px;">$' + total.toLocaleString('es-CO') + '</span>';
    } else {
        display.innerHTML = '<span style="color:#10b981;font-weight:700;font-size:18px;">$0</span>';
    }
}

function agregarProductosOfertaMesero() {
    const descuento = window.ofertaDescuento;
    const productos = window.ofertaProductosData;
    let agregados = 0;

    // Agregar variantes seleccionadas
    document.querySelectorAll('.var-btn.selected').forEach(function(btn) {
        const pidx = parseInt(btn.dataset.pidx);
        const p = productos[pidx];
        const varianteNombre = btn.dataset.variante || '';  // Nombre de la variante
        const nombre = btn.dataset.nombre + ' (-' + descuento + '%)';
        const precio = parseInt(btn.dataset.precio);
        const precioOriginal = parseInt(btn.dataset.original);

        const existing = cart.find(item => item.nombre === nombre);
        if (existing) {
            existing.qty++;
        } else {
            cart.push({
                id: p.id,
                nombre: nombre,
                precio: precio,
                precioOriginal: precioOriginal,
                imagen: p.imagen || '',
                qty: 1,
                isOferta: false,
                esDescuento: true,
                variante: varianteNombre  // Agregar variante para notas
            });
        }
        agregados++;
    });

    // Agregar productos sin variantes
    document.querySelectorAll('.producto-sin-variante').forEach(function(inp) {
        const pidx = parseInt(inp.dataset.pidx);
        const p = productos[pidx];
        const nombre = inp.dataset.nombre + ' (-' + descuento + '%)';
        const precio = parseInt(inp.dataset.precio);
        const precioOriginal = parseInt(inp.dataset.original);

        const existing = cart.find(item => item.nombre === nombre);
        if (existing) {
            existing.qty++;
        } else {
            cart.push({
                id: p.id,
                nombre: nombre,
                precio: precio,
                precioOriginal: precioOriginal,
                imagen: p.imagen || '',
                qty: 1,
                isOferta: false,
                esDescuento: true,
                variante: ''  // Sin variante
            });
        }
        agregados++;
    });

    if (agregados === 0) {
        showToast('Selecciona al menos un producto', 'error');
        return;
    }

    document.getElementById('ofertaModalMesero').remove();
    renderCart();
    showToast('✓ ' + agregados + ' productos agregados', 'success');
}
</script>
{% endblock %}
