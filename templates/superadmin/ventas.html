{% extends 'superadmin/base.html' %}

{% block title %}Ventas Globales{% endblock %}
{% block page_title %}Ventas Globales{% endblock %}
{% block page_subtitle %}Resumen de ventas de todas las tiendas{% endblock %}

{% block content %}
<!-- Filtros de Fecha -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; padding: 15px 20px;">
        <div>
            <label style="font-size: 12px; color: var(--gray);">Desde</label>
            <input type="date" id="fechaDesde" class="form-control" value="{{ fecha_desde }}">
        </div>
        <div>
            <label style="font-size: 12px; color: var(--gray);">Hasta</label>
            <input type="date" id="fechaHasta" class="form-control" value="{{ fecha_hasta }}">
        </div>
        <div>
            <label style="font-size: 12px; color: var(--gray);">Tienda</label>
            <select id="filtroTienda" class="form-control" style="width: 180px;">
                <option value="">Todas</option>
                {% for t in tiendas %}
                <option value="{{ t.id }}" {% if tienda_seleccionada == t.id %}selected{% endif %}>{{ t.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <button class="btn btn-primary" onclick="aplicarFiltros()" style="margin-top: 18px;">
            <i class="fas fa-search"></i> Aplicar
        </button>
        <div style="margin-left: auto; display: flex; gap: 10px; margin-top: 18px;">
            <button class="btn btn-secondary" onclick="setRango('hoy')">Hoy</button>
            <button class="btn btn-secondary" onclick="setRango('semana')">Esta Semana</button>
            <button class="btn btn-secondary" onclick="setRango('mes')">Este Mes</button>
        </div>
    </div>
</div>

<!-- EstadÃ­sticas Principales -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
        <div class="stat-value">${{ "{:,.0f}".format(stats.total_ventas) }}</div>
        <div class="stat-label">Ventas Totales</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-receipt"></i></div>
        <div class="stat-value">{{ stats.total_pedidos }}</div>
        <div class="stat-label">Pedidos</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-calculator"></i></div>
        <div class="stat-value">${{ "{:,.0f}".format(stats.ticket_promedio) }}</div>
        <div class="stat-label">Ticket Promedio</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-store"></i></div>
        <div class="stat-value">{{ stats.tiendas_activas }}</div>
        <div class="stat-label">Tiendas con Ventas</div>
    </div>
</div>

<div class="grid-2">
    <!-- Ventas por Tienda -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-chart-bar"></i> Ventas por Tienda</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Tienda</th>
                        <th>Pedidos</th>
                        <th>Ventas</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tienda in ventas_por_tienda %}
                    <tr>
                        <td>
                            <strong>{{ tienda.nombre }}</strong><br>
                            <small style="color: var(--gray);">{{ tienda.subdominio }}.vxplay.online</small>
                        </td>
                        <td>{{ tienda.pedidos }}</td>
                        <td><strong>${{ "{:,.0f}".format(tienda.ventas) }}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1; background: var(--light); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div style="width: {{ tienda.porcentaje }}%; background: var(--primary); height: 100%;"></div>
                                </div>
                                <span style="font-size: 12px;">{{ tienda.porcentaje }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Productos MÃ¡s Vendidos -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-trophy"></i> Productos MÃ¡s Vendidos</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Producto</th>
                        <th>Tienda</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i, producto in enumerate(productos_top) %}
                    <tr>
                        <td>
                            {% if i == 0 %}
                            <span style="color: gold; font-size: 20px;">ðŸ¥‡</span>
                            {% elif i == 1 %}
                            <span style="color: silver; font-size: 20px;">ðŸ¥ˆ</span>
                            {% elif i == 2 %}
                            <span style="color: #cd7f32; font-size: 20px;">ðŸ¥‰</span>
                            {% else %}
                            <span style="color: var(--gray);">{{ i + 1 }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ producto.nombre }}</strong></td>
                        <td>
                            <small style="background: var(--light); padding: 2px 6px; border-radius: 4px;">
                                {{ producto.tienda_nombre }}
                            </small>
                        </td>
                        <td>{{ producto.cantidad }}</td>
                        <td>${{ "{:,.0f}".format(producto.total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- GrÃ¡fico de Ventas Diarias -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3><i class="fas fa-chart-line"></i> Ventas Diarias</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; align-items: flex-end; height: 250px; gap: 5px; justify-content: space-between; padding: 0 10px;">
            {% for dia in ventas_diarias %}
            <div style="flex: 1; text-align: center; max-width: 80px;">
                <div style="background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
                            width: 100%; height: {{ dia.porcentaje }}%; border-radius: 4px 4px 0 0;
                            min-height: 20px; transition: all 0.3s;"
                     title="${{ '{:,.0f}'.format(dia.total) }}"></div>
                <small style="color: var(--gray); display: block; margin-top: 8px; font-size: 10px;">{{ dia.fecha_corta }}</small>
                <small style="color: var(--dark); font-weight: 600; font-size: 11px;">${{ "{:,.0f}".format(dia.total) }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Exportar -->
<div class="card" style="margin-top: 20px;">
    <div class="card-body" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h4 style="margin: 0;">Exportar Datos</h4>
            <small style="color: var(--gray);">Descargar reporte de ventas en diferentes formatos</small>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="exportar('excel')">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-danger" onclick="exportar('pdf')">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button class="btn btn-secondary" onclick="exportar('csv')">
                <i class="fas fa-file-csv"></i> CSV
            </button>
        </div>
    </div>
</div>

<script>
function aplicarFiltros() {
    const desde = document.getElementById('fechaDesde').value;
    const hasta = document.getElementById('fechaHasta').value;
    const tienda = document.getElementById('filtroTienda').value;

    let url = '/superadmin/ventas?';
    if (desde) url += `desde=${desde}&`;
    if (hasta) url += `hasta=${hasta}&`;
    if (tienda) url += `tienda=${tienda}&`;

    window.location.href = url;
}

function setRango(rango) {
    const hoy = new Date();
    let desde = new Date();

    if (rango === 'hoy') {
        desde = hoy;
    } else if (rango === 'semana') {
        desde.setDate(hoy.getDate() - 7);
    } else if (rango === 'mes') {
        desde.setMonth(hoy.getMonth() - 1);
    }

    document.getElementById('fechaDesde').value = desde.toISOString().split('T')[0];
    document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
    aplicarFiltros();
}

function exportar(formato) {
    const desde = document.getElementById('fechaDesde').value;
    const hasta = document.getElementById('fechaHasta').value;
    const tienda = document.getElementById('filtroTienda').value;

    let url = `/superadmin/api/ventas/exportar?formato=${formato}`;
    if (desde) url += `&desde=${desde}`;
    if (hasta) url += `&hasta=${hasta}`;
    if (tienda) url += `&tienda=${tienda}`;

    window.open(url, '_blank');
}
</script>
{% endblock %}
