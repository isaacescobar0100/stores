{% extends 'base.html' %}

{% block title %}Checkout - {{ tienda.nombre }}{% endblock %}

{% block extra_styles %}
/* ============ CHECKOUT PAGE - DISEÑO MODERNO ============ */
.checkout-page {
    min-height: 100vh;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    padding: 20px;
    padding-bottom: 100px;
}

.checkout-container {
    max-width: 480px;
    margin: 0 auto;
}

/* Header mejorado */
.checkout-header {
    text-align: center;
    margin-bottom: 24px;
    padding: 20px 0;
}

.checkout-header h1 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 12px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.checkout-header h1::before {
    content: '';
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.checkout-back {
    color: var(--primary);
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    background: var(--primary-light);
    transition: all 0.3s ease;
}

.checkout-back:hover {
    background: var(--primary);
    color: white;
    transform: translateX(-4px);
}

/* ============ STEPPER DE PROGRESO ============ */
.checkout-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    margin-bottom: 28px;
    padding: 0 10px;
}

.stepper-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 1;
}

.stepper-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--text-muted);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.stepper-step.active .stepper-icon {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-color: var(--primary);
    color: white;
    box-shadow: 0 4px 15px var(--primary-light);
    transform: scale(1.1);
}

.stepper-step.completed .stepper-icon {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
    color: white;
}

.stepper-step.completed .stepper-icon::after {
    content: '\f00c';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
}

.stepper-step.completed .stepper-icon i {
    display: none;
}

.stepper-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    margin-top: 8px;
    text-align: center;
    transition: color 0.3s;
}

.stepper-step.active .stepper-label,
.stepper-step.completed .stepper-label {
    color: var(--text-primary);
}

.stepper-line {
    flex: 1;
    height: 3px;
    background: var(--border-color);
    margin: 0 -5px;
    margin-bottom: 20px;
    position: relative;
    max-width: 60px;
    min-width: 40px;
}

.stepper-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #10b981, var(--primary));
    transition: width 0.5s ease;
}

.stepper-line.completed::after {
    width: 100%;
}

/* Cards mejoradas */
.checkout-card {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.checkout-card:hover {
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.checkout-card h2 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border-color);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.checkout-card h2 i {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary-light), transparent);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-size: 14px;
}

/* Resumen del pedido mejorado */
.order-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.order-item:last-of-type {
    border-bottom: none;
}

.order-item-img {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    background: var(--bg-secondary);
    flex-shrink: 0;
}

.order-item-info {
    flex: 1;
    min-width: 0;
}

.order-item-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.order-item-qty {
    font-size: 12px;
    color: var(--text-secondary);
}

.order-item-price {
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
}

.order-subtotals {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 2px dashed var(--border-color);
}

.order-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 14px;
    color: var(--text-secondary);
}

.order-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    margin-top: 12px;
    background: linear-gradient(135deg, var(--primary-light), transparent);
    border-radius: 12px;
    font-size: 18px;
    font-weight: 800;
}

.order-total span:last-child {
    color: var(--primary);
    font-size: 22px;
}

/* Selector tipo de pedido mejorado */
.tipo-pedido {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.tipo-btn {
    position: relative;
    padding: 20px 16px;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    background: var(--bg-card);
    cursor: pointer;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.tipo-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.tipo-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.tipo-btn.active {
    border-color: var(--primary);
    background: linear-gradient(to bottom, var(--primary-light), var(--bg-card));
}

.tipo-btn.active::before {
    transform: scaleX(1);
}

.tipo-btn-icon {
    width: 56px;
    height: 56px;
    margin: 0 auto 12px;
    background: var(--bg-secondary);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.tipo-btn.active .tipo-btn-icon {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 15px var(--primary-light);
}

.tipo-btn-text {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
}

.tipo-btn-desc {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.tipo-btn.active .tipo-btn-text {
    color: var(--primary);
}

/* Checkmark en selección activa */
.tipo-btn-check {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.tipo-btn.active .tipo-btn-check {
    opacity: 1;
    transform: scale(1);
}

/* Success page */
.checkout-success {
    text-align: center;
    padding: 40px;
}

.success-icon { font-size: 64px; margin-bottom: 16px; }
.success-order { font-size: 32px; font-weight: 700; color: var(--primary); }

/* Cliente encontrado banner */
.cliente-encontrado {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    border: 2px solid #22c55e;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.cliente-encontrado i {
    width: 40px;
    height: 40px;
    background: #22c55e;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-shrink: 0;
}

.cliente-encontrado-texto {
    flex: 1;
}

.cliente-encontrado-nombre {
    font-weight: 700;
    color: #166534;
    font-size: 15px;
}

.cliente-encontrado-dir {
    font-size: 13px;
    color: #15803d;
    margin-top: 2px;
}

.btn-cambiar-dir {
    background: white;
    border: 2px solid #22c55e;
    color: #22c55e;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cambiar-dir:hover {
    background: #22c55e;
    color: white;
    transform: scale(1.05);
}

.campo-bloqueado {
    background: var(--bg-secondary) !important;
    color: var(--text-secondary);
    border-color: var(--border-color) !important;
}

/* ============ METODO DE PAGO ============ */
.metodo-pago {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.metodo-btn {
    position: relative;
    padding: 20px 16px;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    background: var(--bg-card);
    cursor: pointer;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.metodo-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.metodo-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.metodo-btn.active {
    border-color: var(--primary);
    background: linear-gradient(to bottom, var(--primary-light), var(--bg-card));
}

.metodo-btn.active::before {
    transform: scaleX(1);
}

.metodo-btn-icon {
    width: 56px;
    height: 56px;
    margin: 0 auto 12px;
    background: var(--bg-secondary);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.metodo-btn.active .metodo-btn-icon {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 15px var(--primary-light);
}

.metodo-btn-icon.wompi {
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
}

.metodo-btn.active .metodo-btn-icon.wompi {
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
}

.metodo-btn-text {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
}

.metodo-btn-desc {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.metodo-btn.active .metodo-btn-text {
    color: var(--primary);
}

.metodo-btn-check {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
}

.metodo-btn.active .metodo-btn-check {
    opacity: 1;
    transform: scale(1);
}

.wompi-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    margin-top: 8px;
}

.metodo-pago-info {
    margin-top: 16px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.metodo-pago-info i {
    color: var(--primary);
    font-size: 16px;
}

.metodo-pago-info.wompi-info {
    background: linear-gradient(135deg, #ede9fe, #ddd6fe);
    color: #5b21b6;
}

.metodo-pago-info.wompi-info i {
    color: #7c3aed;
}

/* ============ FORMULARIO MEJORADO ============ */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid var(--border-color);
    border-radius: 14px;
    font-size: 15px;
    background: var(--bg-card);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-light);
    background: var(--bg-primary);
}

.form-input::placeholder {
    color: var(--text-muted);
}

textarea.form-input {
    resize: none;
    min-height: 80px;
}

/* Input con icono */
.input-icon-wrapper {
    position: relative;
}

.input-icon-wrapper .form-input {
    padding-left: 48px;
}

.input-icon-wrapper i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 16px;
    transition: color 0.3s ease;
}

.input-icon-wrapper .form-input:focus + i,
.input-icon-wrapper:focus-within i {
    color: var(--primary);
}

/* Botón de confirmar */
.btn-confirm-order {
    width: 100%;
    padding: 18px 24px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 20px var(--primary-light);
    position: relative;
    overflow: hidden;
}

.btn-confirm-order::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.btn-confirm-order:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px var(--primary-light);
}

.btn-confirm-order:hover::before {
    left: 100%;
}

.btn-confirm-order:active {
    transform: translateY(0);
}

.btn-confirm-order i {
    font-size: 18px;
}

/* Modal de rastreo */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
}

.tracking-modal {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 420px;
    width: 90%;
    text-align: center;
    animation: modalIn 0.3s ease;
}

@keyframes modalIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.tracking-icon {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, var(--primary), #ff6b6b);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 32px;
    color: white;
}

.tracking-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 8px;
}

.tracking-subtitle {
    color: var(--gray-500);
    font-size: 14px;
    margin-bottom: 24px;
}

.order-number-box {
    background: var(--gray-100);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.order-number-text {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
}

.btn-copy {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-copy:hover {
    transform: scale(1.05);
}

.btn-copy.copied {
    background: #22c55e;
}

.tracking-divider {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 20px 0;
    color: var(--gray-400);
    font-size: 13px;
}

.tracking-divider::before,
.tracking-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--gray-200);
}

.tracking-input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.tracking-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
}

.tracking-input:focus {
    outline: none;
    border-color: var(--primary);
}

.btn-track {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-track:hover {
    opacity: 0.9;
}

.tracking-result {
    margin-top: 16px;
    padding: 16px;
    border-radius: 12px;
    display: none;
}

.tracking-result.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.tracking-result.pendiente {
    background: #fef2f2;
    border: 1px solid #fecaca;
}

.tracking-result.preparando {
    background: #fffbeb;
    border: 1px solid #fde68a;
}

.tracking-result.listo {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
}

.tracking-result.entregado {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
}

.tracking-status {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
}

.tracking-status.pendiente { color: #dc2626; }
.tracking-status.preparando { color: #d97706; }
.tracking-status.listo { color: #16a34a; }
.tracking-status.entregado { color: #2563eb; }

.tracking-desc {
    font-size: 13px;
    color: var(--gray-600);
}

.btn-close-modal {
    margin-top: 20px;
    background: transparent;
    border: 1px solid var(--gray-300);
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: var(--gray-600);
}

.btn-close-modal:hover {
    background: var(--gray-100);
}

/* Boton flotante de rastreo */
.btn-tracking-float {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    z-index: 100;
    transition: all 0.3s;
}

.btn-tracking-float:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
}

.btn-tracking-float i {
    font-size: 18px;
}
{% endblock %}

{% block content %}
<div class="checkout-page">
    <div class="checkout-container">
        <div class="checkout-header">
            <h1>Finalizar Pedido</h1>
            <a href="/" class="checkout-back"><i class="fas fa-arrow-left"></i> Volver al menú</a>
        </div>

        <!-- Stepper de progreso -->
        <div class="checkout-stepper">
            <div class="stepper-step completed" id="step1">
                <div class="stepper-icon"><i class="fas fa-shopping-cart"></i></div>
                <span class="stepper-label">Carrito</span>
            </div>
            <div class="stepper-line completed" id="line1"></div>
            <div class="stepper-step active" id="step2">
                <div class="stepper-icon"><i class="fas fa-clipboard-list"></i></div>
                <span class="stepper-label">Detalles</span>
            </div>
            <div class="stepper-line" id="line2"></div>
            <div class="stepper-step" id="step3">
                <div class="stepper-icon"><i class="fas fa-check-circle"></i></div>
                <span class="stepper-label">Confirmar</span>
            </div>
        </div>

        <div id="checkoutForm">
            <!-- Resumen -->
            <div class="checkout-card">
                <h2><i class="fas fa-receipt"></i> Tu Pedido</h2>
                <div id="orderSummary">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                        <p style="margin-top: 10px;">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- Tipo de pedido -->
            <div class="checkout-card">
                <h2><i class="fas fa-truck"></i> Tipo de Pedido</h2>
                <div class="tipo-pedido">
                    <button type="button" class="tipo-btn active" onclick="setTipo('domicilio')" id="tipoDomicilio">
                        <div class="tipo-btn-check"><i class="fas fa-check"></i></div>
                        <div class="tipo-btn-icon"><i class="fas fa-motorcycle"></i></div>
                        <div class="tipo-btn-text">Domicilio</div>
                        <div class="tipo-btn-desc">Te lo llevamos</div>
                    </button>
                    <button type="button" class="tipo-btn" onclick="setTipo('para_llevar')" id="tipoLlevar">
                        <div class="tipo-btn-check"><i class="fas fa-check"></i></div>
                        <div class="tipo-btn-icon"><i class="fas fa-shopping-bag"></i></div>
                        <div class="tipo-btn-text">Para llevar</div>
                        <div class="tipo-btn-desc">Recoge en tienda</div>
                    </button>
                </div>
            </div>

            <!-- Datos del cliente -->
            <div class="checkout-card">
                <h2><i class="fas fa-user"></i> Tus Datos</h2>

                <!-- Banner cliente encontrado (oculto por defecto) -->
                <div id="clienteEncontrado" class="cliente-encontrado" style="display: none;">
                    <i class="fas fa-check"></i>
                    <div class="cliente-encontrado-texto">
                        <div class="cliente-encontrado-nombre" id="clienteNombre"></div>
                        <div class="cliente-encontrado-dir" id="clienteDir"></div>
                    </div>
                    <button type="button" class="btn-cambiar-dir" onclick="cambiarDireccion()">Cambiar</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Teléfono *</label>
                    <div class="input-icon-wrapper">
                        <input type="tel" id="telefono" class="form-input" required placeholder="Tu número de teléfono" oninput="buscarCliente()">
                        <i class="fas fa-phone"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <div class="input-icon-wrapper">
                        <input type="text" id="nombre" class="form-input" required placeholder="Tu nombre completo">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div id="direccionGroup">
                    <div class="form-group">
                        <label class="form-label">Dirección *</label>
                        <div class="input-icon-wrapper">
                            <input type="text" id="direccion" class="form-input" placeholder="Tu dirección de entrega">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Referencias</label>
                        <div class="input-icon-wrapper">
                            <input type="text" id="referencias" class="form-input" placeholder="Ej: Casa azul, portón negro">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notas para tu pedido</label>
                    <textarea id="notas" class="form-input" rows="2" placeholder="Ej: Sin cebolla, extra picante..."></textarea>
                </div>
            </div>

            <!-- Método de Pago -->
            <div class="checkout-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Método de Pago
                </h3>
                <div class="metodo-pago">
                    <button type="button" class="metodo-btn active" data-metodo="efectivo" onclick="seleccionarMetodoPago('efectivo')">
                        <div class="metodo-btn-icon efectivo">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <span class="metodo-btn-label">Efectivo</span>
                        <span class="metodo-btn-desc">Paga al recibir</span>
                        <i class="fas fa-check metodo-check"></i>
                    </button>
                    <button type="button" class="metodo-btn" id="btnWompi" data-metodo="wompi" onclick="seleccionarMetodoPago('wompi')" style="display: none;">
                        <div class="metodo-btn-icon wompi">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span class="metodo-btn-label">Wompi</span>
                        <span class="metodo-btn-desc">Pago en línea</span>
                        <span class="wompi-badge">Seguro</span>
                        <i class="fas fa-check metodo-check"></i>
                    </button>
                </div>
                <div class="metodo-pago-info efectivo-info" id="efectivoInfo">
                    <i class="fas fa-info-circle"></i>
                    Pagarás en efectivo cuando recibas tu pedido
                </div>
                <div class="metodo-pago-info wompi-info" id="wompiInfo" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    Serás redirigido a Wompi para completar tu pago de forma segura
                </div>
            </div>

            <button class="btn-confirm-order" onclick="enviarPedido()">
                <i class="fas fa-paper-plane"></i>
                <span id="btnConfirmText">Confirmar Pedido</span>
            </button>
        </div>

        <!-- Success -->
        <div class="checkout-card checkout-success" id="checkoutSuccess" style="display: none;">
            <div class="success-icon">✓</div>
            <h2>¡Pedido Recibido!</h2>
            <div class="success-order" id="orderNumber"></div>
            <p class="text-muted mt-3">Te avisaremos cuando esté listo</p>
            <div class="tracking-info-box">
                <p><strong>Para rastrear tu pedido</strong></p>
                <p>Usa tu número de teléfono en la página de inicio</p>
            </div>
            <a href="/" class="btn btn-primary mt-4">Volver al menú</a>
        </div>
    </div>
</div>

<style>
.success-icon {
    font-size: 60px;
    color: #22c55e;
    margin-bottom: 16px;
}
.tracking-info-box {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
    text-align: center;
}
.tracking-info-box p {
    margin: 4px 0;
    color: #0369a1;
}
.tracking-info-box p:first-child {
    font-size: 16px;
}
.tracking-info-box p:last-child {
    font-size: 14px;
    opacity: 0.8;
}
</style>

{% endblock %}

{% block scripts %}
<!-- Wompi Widget -->
<script src="https://checkout.wompi.co/widget.js"></script>
<script>
let tipoPedido = 'domicilio';
let metodoPago = 'efectivo';
let cartData = null;
let clienteData = null;
let buscarTimeout = null;
let wompiHabilitado = false;

// Verificar si Wompi está habilitado para esta tienda
(function verificarWompi() {
    fetch('/api/wompi/config')
        .then(r => r.json())
        .then(config => {
            wompiHabilitado = config.habilitado;
            if (wompiHabilitado) {
                document.getElementById('btnWompi').style.display = 'flex';
            }
        })
        .catch(() => {
            // Si hay error, Wompi se queda oculto
            wompiHabilitado = false;
        });
})();

// Seleccionar método de pago
function seleccionarMetodoPago(metodo) {
    metodoPago = metodo;

    // Actualizar botones
    document.querySelectorAll('.metodo-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.metodo-btn[data-metodo="${metodo}"]`).classList.add('active');

    // Mostrar info correspondiente
    document.getElementById('efectivoInfo').style.display = metodo === 'efectivo' ? 'flex' : 'none';
    document.getElementById('wompiInfo').style.display = metodo === 'wompi' ? 'flex' : 'none';

    // Cambiar texto del botón
    const btnText = document.getElementById('btnConfirmText');
    if (metodo === 'wompi') {
        btnText.innerHTML = '<i class="fas fa-lock"></i> Pagar con Wompi';
    } else {
        btnText.textContent = 'Confirmar Pedido';
    }
}

// Buscar cliente cuando escribe telefono
function buscarCliente() {
    const telefono = document.getElementById('telefono').value.trim();

    // Cancelar busqueda anterior
    if (buscarTimeout) clearTimeout(buscarTimeout);

    // Ocultar banner si telefono muy corto
    if (telefono.length < 7) {
        document.getElementById('clienteEncontrado').style.display = 'none';
        clienteData = null;
        limpiarCampos();
        return;
    }

    // Esperar 500ms antes de buscar
    buscarTimeout = setTimeout(() => {
        fetch('/api/cliente/buscar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefono: telefono })
        })
        .then(r => r.json())
        .then(data => {
            if (data.encontrado) {
                clienteData = data;
                mostrarClienteEncontrado(data);
            } else {
                clienteData = null;
                document.getElementById('clienteEncontrado').style.display = 'none';
                limpiarCampos();
            }
        })
        .catch(err => console.error('Error buscando cliente:', err));
    }, 500);
}

function mostrarClienteEncontrado(data) {
    document.getElementById('clienteEncontrado').style.display = 'flex';
    document.getElementById('clienteNombre').textContent = '¡Hola ' + data.nombre + '!';
    document.getElementById('clienteDir').textContent = data.direccion ? 'Enviar a: ' + data.direccion : 'Sin dirección guardada';

    // Autocompletar campos
    document.getElementById('nombre').value = data.nombre;
    document.getElementById('direccion').value = data.direccion || '';
    document.getElementById('referencias').value = data.referencias || '';

    // Bloquear campos (pueden desbloquearse con "Cambiar")
    document.getElementById('nombre').classList.add('campo-bloqueado');
    document.getElementById('nombre').readOnly = true;
    document.getElementById('direccion').classList.add('campo-bloqueado');
    document.getElementById('direccion').readOnly = true;
    document.getElementById('referencias').classList.add('campo-bloqueado');
    document.getElementById('referencias').readOnly = true;
}

function cambiarDireccion() {
    // Desbloquear campos para editar
    document.getElementById('nombre').classList.remove('campo-bloqueado');
    document.getElementById('nombre').readOnly = false;
    document.getElementById('direccion').classList.remove('campo-bloqueado');
    document.getElementById('direccion').readOnly = false;
    document.getElementById('referencias').classList.remove('campo-bloqueado');
    document.getElementById('referencias').readOnly = false;

    // Ocultar banner
    document.getElementById('clienteEncontrado').style.display = 'none';

    // Enfocar direccion
    document.getElementById('direccion').focus();
}

function limpiarCampos() {
    document.getElementById('nombre').value = '';
    document.getElementById('nombre').classList.remove('campo-bloqueado');
    document.getElementById('nombre').readOnly = false;
    document.getElementById('direccion').value = '';
    document.getElementById('direccion').classList.remove('campo-bloqueado');
    document.getElementById('direccion').readOnly = false;
    document.getElementById('referencias').value = '';
    document.getElementById('referencias').classList.remove('campo-bloqueado');
    document.getElementById('referencias').readOnly = false;
}

function loadCart() {
    fetch('/api/carrito')
        .then(r => r.json())
        .then(data => {
            cartData = data;
            if (data.carrito.length === 0) {
                window.location.href = '/';
                return;
            }
            renderSummary(data);
        });
}

const PLACEHOLDER_IMG = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"%3E%3Crect fill="%23f0f0f0" width="60" height="60"/%3E%3Cpath fill="%23ccc" d="M20 25h20v10H20z"/%3E%3Ccircle fill="%23ccc" cx="25" cy="22" r="4"/%3E%3C/svg%3E';

function renderSummary(data) {
    // Items del carrito con imagen
    let html = '<div class="order-items-list">';
    html += data.carrito.map(item => `
        <div class="order-item">
            <img class="order-item-img" src="${item.imagen || PLACEHOLDER_IMG}" alt="${item.nombre}" onerror="this.src=PLACEHOLDER_IMG">
            <div class="order-item-info">
                <div class="order-item-name">${item.nombre}</div>
                <div class="order-item-qty">${item.cantidad} x $${formatPrice(item.precio)}</div>
            </div>
            <div class="order-item-price">$${formatPrice(item.precio * item.cantidad)}</div>
        </div>
    `).join('');
    html += '</div>';

    // Subtotales
    html += '<div class="order-subtotals">';
    html += `
        <div class="order-row">
            <span>Subtotal</span>
            <span>$${formatPrice(data.subtotal)}</span>
        </div>
    `;

    if (tipoPedido === 'domicilio') {
        html += `
            <div class="order-row">
                <span><i class="fas fa-motorcycle" style="margin-right: 6px;"></i>Envío a domicilio</span>
                <span>${data.costo_domicilio > 0 ? '$' + formatPrice(data.costo_domicilio) : 'Gratis'}</span>
            </div>
        `;
    }
    html += '</div>';

    // Total
    const total = tipoPedido === 'domicilio' ? data.total : data.subtotal;
    html += `
        <div class="order-total">
            <span>Total a pagar</span>
            <span>$${formatPrice(total)}</span>
        </div>
    `;

    document.getElementById('orderSummary').innerHTML = html;
}

function formatPrice(price) {
    return Number(price).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function setTipo(tipo) {
    tipoPedido = tipo;
    document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tipo === 'domicilio' ? 'tipoDomicilio' : 'tipoLlevar').classList.add('active');
    document.getElementById('direccionGroup').style.display = tipo === 'domicilio' ? 'block' : 'none';
    if (cartData) renderSummary(cartData);
}

let currentOrderNumber = '';

function enviarPedido() {
    const nombre = document.getElementById('nombre').value;
    const telefono = document.getElementById('telefono').value;
    const direccion = document.getElementById('direccion').value;
    const referencias = document.getElementById('referencias').value;
    const notas = document.getElementById('notas').value;

    if (!nombre || !telefono) {
        alert('Por favor completa nombre y teléfono');
        return;
    }

    if (tipoPedido === 'domicilio' && !direccion) {
        alert('Por favor ingresa tu dirección');
        return;
    }

    // Si es pago con Wompi, primero crear el pedido y luego abrir widget
    if (metodoPago === 'wompi') {
        procesarPagoWompi(nombre, telefono, direccion, referencias, notas);
        return;
    }

    // Pago en efectivo - flujo normal
    crearPedidoEfectivo(nombre, telefono, direccion, referencias, notas);
}

function crearPedidoEfectivo(nombre, telefono, direccion, referencias, notas) {
    fetch('/api/pedido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            nombre, telefono, direccion, referencias, notas,
            tipo: tipoPedido,
            metodo_pago: 'efectivo'
        })
    })
    .then(r => {
        if (!r.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            mostrarExito(data.numero_orden);
        } else {
            alert(data.error || 'Error al crear pedido');
        }
    })
    .catch(err => {
        console.error('Error enviando pedido:', err);
    });
}

function procesarPagoWompi(nombre, telefono, direccion, referencias, notas) {
    // Calcular total
    const total = tipoPedido === 'domicilio' ? cartData.total : cartData.subtotal;

    // Primero obtener la configuración de Wompi
    fetch('/api/wompi/config')
        .then(r => r.json())
        .then(config => {
            if (!config.habilitado) {
                alert('El pago en línea no está disponible en este momento. Por favor selecciona pago en efectivo.');
                return;
            }

            // Crear transacción en backend
            fetch('/api/wompi/crear-transaccion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre, telefono, direccion, referencias, notas,
                    tipo: tipoPedido,
                    total: total * 100 // Wompi usa centavos
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Abrir widget de Wompi
                    abrirWidgetWompi(data, config.public_key);
                } else {
                    alert(data.error || 'Error al iniciar pago');
                }
            })
            .catch(err => {
                console.error('Error creando transacción:', err);
                alert('Error al procesar el pago. Intenta de nuevo.');
            });
        })
        .catch(err => {
            console.error('Error obteniendo config Wompi:', err);
            alert('Error de conexión. Intenta de nuevo.');
        });
}

function abrirWidgetWompi(transaccion, publicKey) {
    // Debug: mostrar datos de la transacción
    console.log('=== WOMPI DEBUG ===');
    console.log('Public Key:', publicKey);
    console.log('Referencia:', transaccion.referencia);
    console.log('Monto (centavos):', transaccion.monto);
    console.log('Firma:', transaccion.firma);
    console.log('==================');

    try {
        const checkout = new WidgetCheckout({
            currency: 'COP',
            amountInCents: transaccion.monto,
            reference: transaccion.referencia,
            publicKey: publicKey,
            signature: {
                integrity: transaccion.firma
            },
            redirectUrl: window.location.origin + '/pago/resultado?ref=' + transaccion.referencia,
            customerData: {
                email: transaccion.email || 'cliente@example.com',
                fullName: transaccion.nombre,
                phoneNumber: transaccion.telefono,
                phoneNumberPrefix: '+57'
            },
            onError: function(error) {
                console.error('Error Wompi Widget:', error);
                alert('Error al abrir el pago: ' + (error.message || JSON.stringify(error)));
            }
        });

        checkout.open(function(result) {
            console.log('Resultado completo:', result);
            const transaction = result.transaction;

            if (!transaction) {
                console.log('Widget cerrado sin transacción');
                return;
            }

            console.log('Resultado transacción:', transaction);

            if (transaction.status === 'APPROVED') {
                // Redirigir a página de resultado
                window.location.href = '/pago/resultado?ref=' + transaccion.referencia;
            } else if (transaction.status === 'DECLINED' || transaction.status === 'ERROR') {
                alert('El pago no fue aprobado. Puedes intentar de nuevo o pagar en efectivo.');
            }
            // Si está pendiente, se verificará vía webhook
        });
    } catch (error) {
        console.error('Error al crear WidgetCheckout:', error);
        alert('Error al inicializar el pago. Ver consola para detalles.');
    }
}

function mostrarExito(numeroOrden) {
    currentOrderNumber = numeroOrden;

    // Actualizar stepper a completado
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step2').classList.add('completed');
    document.getElementById('line2').classList.add('completed');
    document.getElementById('step3').classList.add('active');

    document.getElementById('checkoutForm').style.display = 'none';
    document.getElementById('checkoutSuccess').style.display = 'block';
    document.getElementById('orderNumber').textContent = '#' + numeroOrden;

    // Registrar pedido para notificaciones
    if (typeof trackNewOrder === 'function') {
        trackNewOrder(numeroOrden, 'pendiente');
    }
}

loadCart();

// Auto-buscar si viene telefono en URL
function checkUrlTelefono() {
    const params = new URLSearchParams(window.location.search);
    const telefono = params.get('telefono');
    if (telefono) {
        document.getElementById('telefono').value = telefono;
        // Buscar cliente automaticamente
        fetch('/api/cliente/buscar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ telefono: telefono })
        })
        .then(r => r.json())
        .then(data => {
            if (data.encontrado) {
                clienteData = data;
                mostrarClienteEncontrado(data);
            }
        })
        .catch(err => console.error('Error buscando cliente:', err));
    }
}
checkUrlTelefono();
</script>
{% endblock %}
