{% extends 'superadmin/base.html' %}

{% block title %}Gestión de Tiendas{% endblock %}
{% block page_title %}Gestión de Tiendas{% endblock %}
{% block page_subtitle %}Administrar todas las tiendas del sistema{% endblock %}

{% block content %}
<!-- Toolbar -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="buscarTienda" placeholder="Buscar tienda..." class="form-control" style="width: 250px;">
            <select id="filtroEstado" class="form-control" style="width: 150px;">
                <option value="">Todos</option>
                <option value="activa">Activas</option>
                <option value="inactiva">Inactivas</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="abrirModalNueva()">
            <i class="fas fa-plus"></i> Nueva Tienda
        </button>
    </div>
</div>

<!-- Tabla de Tiendas -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-store"></i> Tiendas Registradas ({{ tiendas|length }})</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tienda</th>
                    <th>Subdominio</th>
                    <th>Productos</th>
                    <th>Pedidos Hoy</th>
                    <th>Ventas Hoy</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for tienda in tiendas %}
                <tr>
                    <td><strong>#{{ tienda.id }}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                {{ tienda.nombre[0] }}
                            </div>
                            <div>
                                <strong>{{ tienda.nombre }}</strong><br>
                                <small style="color: var(--gray);">{{ tienda.email or 'Sin email' }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="https://{{ tienda.subdominio }}.vxplay.online" target="_blank" style="color: var(--primary);">
                            {{ tienda.subdominio }}.vxplay.online
                            <i class="fas fa-external-link-alt" style="font-size: 10px; margin-left: 5px;"></i>
                        </a>
                    </td>
                    <td>{{ tienda.total_productos or 0 }}</td>
                    <td>{{ tienda.pedidos_hoy or 0 }}</td>
                    <td>${{ "{:,.0f}".format(tienda.ventas_hoy or 0) }}</td>
                    <td>
                        <span class="badge badge-{% if tienda.activa %}success{% else %}danger{% endif %}">
                            {{ 'Activa' if tienda.activa else 'Inactiva' }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-secondary" onclick="verDetalle({{ tienda.id }})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editarTienda({{ tienda.id }})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-{% if tienda.activa %}warning{% else %}success{% endif %}"
                                    onclick="toggleEstado({{ tienda.id }}, {{ 'true' if tienda.activa else 'false' }})"
                                    title="{{ 'Desactivar' if tienda.activa else 'Activar' }}">
                                <i class="fas fa-{% if tienda.activa %}pause{% else %}play{% endif %}"></i>
                            </button>
                            <a href="/superadmin/tiendas/{{ tienda.id }}/usuarios" class="btn btn-sm btn-secondary" title="Usuarios">
                                <i class="fas fa-users"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nueva/Editar Tienda -->
<div id="modalTienda" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitulo">Nueva Tienda</h3>
            <button class="modal-close" onclick="cerrarModal()">&times;</button>
        </div>
        <form id="formTienda" onsubmit="guardarTienda(event)">
            <input type="hidden" id="tiendaId" name="id">
            <div class="form-group">
                <label>Nombre de la Tienda *</label>
                <input type="text" id="tiendaNombre" name="nombre" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Subdominio * <small style="color: var(--gray);">(sin espacios, solo letras y números)</small></label>
                <div style="display: flex; align-items: center;">
                    <input type="text" id="tiendaSubdominio" name="subdominio" class="form-control"
                           pattern="[a-z0-9-]+" style="border-radius: 4px 0 0 4px;" required>
                    <span style="background: var(--light); padding: 10px 15px; border: 1px solid var(--gray-light); border-left: none; border-radius: 0 4px 4px 0;">
                        .vxplay.online
                    </span>
                </div>
            </div>
            <div class="form-group">
                <label>Email de Contacto</label>
                <input type="email" id="tiendaEmail" name="email" class="form-control">
            </div>
            <div class="form-group">
                <label>Teléfono</label>
                <input type="text" id="tiendaTelefono" name="telefono" class="form-control">
            </div>
            <div class="form-group">
                <label>Dirección</label>
                <input type="text" id="tiendaDireccion" name="direccion" class="form-control">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Detalle Tienda -->
<div id="modalDetalle" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-store"></i> <span id="detalleNombre"></span></h3>
            <button class="modal-close" onclick="cerrarModalDetalle()">&times;</button>
        </div>
        <div id="detalleContenido">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
</div>

<script>
function abrirModalNueva() {
    document.getElementById('modalTitulo').textContent = 'Nueva Tienda';
    document.getElementById('formTienda').reset();
    document.getElementById('tiendaId').value = '';
    document.getElementById('modalTienda').classList.add('active');
}

function cerrarModal() {
    document.getElementById('modalTienda').classList.remove('active');
}

function cerrarModalDetalle() {
    document.getElementById('modalDetalle').classList.remove('active');
}

function editarTienda(id) {
    fetch(`/superadmin/api/tiendas/${id}`)
        .then(r => r.json())
        .then(tienda => {
            document.getElementById('modalTitulo').textContent = 'Editar Tienda';
            document.getElementById('tiendaId').value = tienda.id;
            document.getElementById('tiendaNombre').value = tienda.nombre;
            document.getElementById('tiendaSubdominio').value = tienda.subdominio;
            document.getElementById('tiendaEmail').value = tienda.email || '';
            document.getElementById('tiendaTelefono').value = tienda.telefono || '';
            document.getElementById('tiendaDireccion').value = tienda.direccion || '';
            document.getElementById('modalTienda').classList.add('active');
        });
}

function guardarTienda(e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const id = data.get('id');
    const url = id ? `/superadmin/api/tiendas/${id}` : '/superadmin/api/tiendas';
    const method = id ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(Object.fromEntries(data))
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Error al guardar');
        }
    });
}

function toggleEstado(id, activa) {
    const accion = activa ? 'desactivar' : 'activar';
    if (confirm(`¿Seguro que desea ${accion} esta tienda?`)) {
        fetch(`/superadmin/api/tiendas/${id}/toggle`, {method: 'POST'})
            .then(r => r.json())
            .then(result => {
                if (result.success) location.reload();
                else alert(result.error);
            });
    }
}

function verDetalle(id) {
    fetch(`/superadmin/api/tiendas/${id}/detalle`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('detalleNombre').textContent = data.nombre;
            document.getElementById('detalleContenido').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${data.total_productos}</div>
                        <div class="stat-label">Productos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total_usuarios}</div>
                        <div class="stat-label">Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.pedidos_hoy}</div>
                        <div class="stat-label">Pedidos Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${data.ventas_hoy.toLocaleString()}</div>
                        <div class="stat-label">Ventas Hoy</div>
                    </div>
                </div>
                <div style="padding: 0 20px 20px;">
                    <p><strong>Subdominio:</strong> <a href="https://${data.subdominio}.vxplay.online" target="_blank">${data.subdominio}.vxplay.online</a></p>
                    <p><strong>Email:</strong> ${data.email || 'No definido'}</p>
                    <p><strong>Teléfono:</strong> ${data.telefono || 'No definido'}</p>
                    <p><strong>Dirección:</strong> ${data.direccion || 'No definida'}</p>
                    <p><strong>Creada:</strong> ${data.fecha_creacion || 'N/A'}</p>
                </div>
            `;
            document.getElementById('modalDetalle').classList.add('active');
        });
}

// Filtros
document.getElementById('buscarTienda').addEventListener('input', filtrarTabla);
document.getElementById('filtroEstado').addEventListener('change', filtrarTabla);

function filtrarTabla() {
    const busqueda = document.getElementById('buscarTienda').value.toLowerCase();
    const estado = document.getElementById('filtroEstado').value;
    const filas = document.querySelectorAll('tbody tr');

    filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        const esActiva = fila.querySelector('.badge-success') !== null;

        let mostrar = texto.includes(busqueda);
        if (estado === 'activa') mostrar = mostrar && esActiva;
        if (estado === 'inactiva') mostrar = mostrar && !esActiva;

        fila.style.display = mostrar ? '' : 'none';
    });
}
</script>
{% endblock %}
