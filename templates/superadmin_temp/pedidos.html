{% extends 'superadmin/base.html' %}

{% block title %}Pedidos Globales{% endblock %}
{% block page_title %}Pedidos Globales{% endblock %}
{% block page_subtitle %}Ver todos los pedidos de todas las tiendas{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; padding: 15px 20px;">
        <div>
            <label style="font-size: 12px; color: var(--gray);">Tienda</label>
            <select id="filtroTienda" class="form-control" style="width: 180px;">
                <option value="">Todas</option>
                {% for t in tiendas %}
                <option value="{{ t.id }}">{{ t.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="font-size: 12px; color: var(--gray);">Estado</label>
            <select id="filtroEstado" class="form-control" style="width: 150px;">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="preparando">Preparando</option>
                <option value="listo">Listo</option>
                <option value="entregado">Entregado</option>
                <option value="cancelado">Cancelado</option>
            </select>
        </div>
        <div>
            <label style="font-size: 12px; color: var(--gray);">Fecha</label>
            <input type="date" id="filtroFecha" class="form-control" value="{{ fecha_hoy }}">
        </div>
        <button class="btn btn-primary" onclick="filtrarPedidos()" style="margin-top: 18px;">
            <i class="fas fa-search"></i> Filtrar
        </button>
        <button class="btn btn-secondary" onclick="exportarPedidos()" style="margin-top: 18px;">
            <i class="fas fa-download"></i> Exportar
        </button>
    </div>
</div>

<!-- Estadísticas Rápidas -->
<div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-receipt"></i></div>
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Pedidos</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
        <div class="stat-value">{{ stats.pendientes }}</div>
        <div class="stat-label">Pendientes</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-fire"></i></div>
        <div class="stat-value">{{ stats.preparando }}</div>
        <div class="stat-label">Preparando</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-check"></i></div>
        <div class="stat-value">{{ stats.entregados }}</div>
        <div class="stat-label">Entregados</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
        <div class="stat-value">${{ "{:,.0f}".format(stats.total_ventas) }}</div>
        <div class="stat-label">Ventas</div>
    </div>
</div>

<!-- Tabla de Pedidos -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-list"></i> Listado de Pedidos</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="table">
            <thead>
                <tr>
                    <th>Orden</th>
                    <th>Tienda</th>
                    <th>Cliente</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Fecha/Hora</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in pedidos %}
                <tr>
                    <td><strong>#{{ pedido.numero_orden }}</strong></td>
                    <td>
                        <span style="background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                            {{ pedido.tienda_nombre }}
                        </span>
                    </td>
                    <td>{{ pedido.cliente_nombre or 'Sin nombre' }}</td>
                    <td>{{ pedido.total_items }} items</td>
                    <td><strong>${{ "{:,.0f}".format(pedido.total) }}</strong></td>
                    <td>
                        <span class="badge badge-{% if pedido.tipo == 'domicilio' %}info{% else %}secondary{% endif %}">
                            {{ pedido.tipo }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{% if pedido.estado == 'entregado' %}success{% elif pedido.estado == 'preparando' %}warning{% elif pedido.estado == 'pendiente' %}info{% elif pedido.estado == 'cancelado' %}danger{% else %}secondary{% endif %}">
                            {{ pedido.estado }}
                        </span>
                    </td>
                    <td>
                        <small>{{ pedido.fecha_hora[:16] if pedido.fecha_hora else 'N/A' }}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="verPedido({{ pedido.id }})" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Detalle Pedido -->
<div id="modalPedido" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-receipt"></i> Detalle del Pedido</h3>
            <button class="modal-close" onclick="cerrarModal()">&times;</button>
        </div>
        <div id="detallePedido">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
</div>

<script>
function verPedido(id) {
    fetch(`/superadmin/api/pedidos/${id}`)
        .then(r => r.json())
        .then(pedido => {
            let itemsHtml = pedido.items.map(item => `
                <tr>
                    <td>${item.cantidad}x</td>
                    <td>${item.producto_nombre}</td>
                    <td>$${item.precio_unitario.toLocaleString()}</td>
                    <td>$${item.subtotal.toLocaleString()}</td>
                </tr>
            `).join('');

            document.getElementById('detallePedido').innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0;">#${pedido.numero_orden}</h2>
                            <small style="color: var(--gray);">${pedido.tienda_nombre}</small>
                        </div>
                        <span class="badge badge-${pedido.estado === 'entregado' ? 'success' : pedido.estado === 'preparando' ? 'warning' : 'info'}" style="height: fit-content; font-size: 14px; padding: 8px 15px;">
                            ${pedido.estado.toUpperCase()}
                        </span>
                    </div>

                    <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0 0 5px 0;"><strong>Cliente:</strong> ${pedido.cliente_nombre || 'No especificado'}</p>
                        <p style="margin: 0 0 5px 0;"><strong>Teléfono:</strong> ${pedido.cliente_telefono || 'No especificado'}</p>
                        <p style="margin: 0 0 5px 0;"><strong>Tipo:</strong> ${pedido.tipo}</p>
                        ${pedido.direccion ? `<p style="margin: 0;"><strong>Dirección:</strong> ${pedido.direccion}</p>` : ''}
                    </div>

                    <table class="table" style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>Cant.</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; background: var(--light);">
                                <td colspan="3" style="text-align: right;">TOTAL:</td>
                                <td>$${pedido.total.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                    </table>

                    ${pedido.notas ? `
                    <div style="background: #fff3cd; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>Notas:</strong> ${pedido.notas}
                    </div>
                    ` : ''}

                    <p style="color: var(--gray); font-size: 12px; margin-top: 15px; text-align: center;">
                        Creado: ${pedido.fecha_hora}
                    </p>
                </div>
            `;
            document.getElementById('modalPedido').classList.add('active');
        });
}

function cerrarModal() {
    document.getElementById('modalPedido').classList.remove('active');
}

function filtrarPedidos() {
    const tienda = document.getElementById('filtroTienda').value;
    const estado = document.getElementById('filtroEstado').value;
    const fecha = document.getElementById('filtroFecha').value;

    let url = '/superadmin/pedidos?';
    if (tienda) url += `tienda=${tienda}&`;
    if (estado) url += `estado=${estado}&`;
    if (fecha) url += `fecha=${fecha}&`;

    window.location.href = url;
}

function exportarPedidos() {
    const tienda = document.getElementById('filtroTienda').value;
    const estado = document.getElementById('filtroEstado').value;
    const fecha = document.getElementById('filtroFecha').value;

    let url = '/superadmin/api/pedidos/exportar?';
    if (tienda) url += `tienda=${tienda}&`;
    if (estado) url += `estado=${estado}&`;
    if (fecha) url += `fecha=${fecha}&`;

    window.open(url, '_blank');
}
</script>
{% endblock %}
